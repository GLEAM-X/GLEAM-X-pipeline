#! /bin/bash -l
#SBATCH --export=NONE
#SBATCH -M HOST
#SBATCH -p STANDARDQ
#SBATCH --account=ACCOUNT
#SBATCH --time=2:00:00
#SBATCH --ntasks=NCPUS
#SBATCH --nodes=1


pipeuser=PIPEUSER
source /group/mwasci/$pipeuser/GLEAM-X-pipeline/GLEAM-X-pipeline.profile

function test_fail {
if [[ $1 != 0 ]]
then
    track_task.py fail --jobid=${SLURM_JOBID} --taskid=1 --finish_time=`date +%s`
    exit $1
fi
}

track_task.py start --jobid=${SLURM_JOBID} --taskid=1 --start_time=`date +%s`

obsnum=OBSNUM
base=BASEDIR
user=ENDUSER
host=ENDPOINT
remote=REMOTE

datadir=${base}/${obsnum}
cd ${datadir}

rsync -avh --progress --stats *csv \
                              *zip \
                              *png \
                              *log \
                              *sources.txt \
                              *fits.sr6 \
                              ${obsnum}_deep-*-psf_crop.fits \
                              ${obsnum}_deep-*-image-pb.fits \
                              ${obsnum}_deep-*-image-pb_warp_weight.fits \
                              ${obsnum}_*_xm.fits \
                              $user@$host:"$remote/$obsnum"

test_fail $?

echo 'Updating database'
track_task.py finish --jobid=${SLURM_JOBID} --taskid=1 --start_time=`date +%s`

track_task.py obs_status --obs_id=${obsnum} --status=archived
echo "Database updated. Obsid $obsid has been archived. "