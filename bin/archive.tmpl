#! /bin/bash -l
#SBATCH --export=NONE
#SBATCH -M HOST
#SBATCH -p STANDARDQ
#SBATCH --account=ACCOUNT
#SBATCH --time=2:00:00
#SBATCH --ntasks=NCPUS
#SBATCH --nodes=1

source /group/mwasci/$SLURM_JOB_USER/GLEAM-X-pipeline/GLEAM-X-pipeline.profile

function test_fail {
if [[ $1 != 0 ]]
then
    track_task.py fail --jobid=${SLURM_JOBID} --taskid=1 --finish_time=`date +%s`
    exit $1
fi
}

obsnum=OBSNUM
base=BASEDIR
user=ENDUSER
host=ENDPOINT
remote=REMOTE

datadir=${base}/${obsnum}
cd ${datadir}

rsync -avh --progress --stats *csv \
                              *zip \
                              *png \
                              *log \
                              *psf.fits \
                              *crop.fits \ 
                              *image-pb_warp.fits \
                              *_crop.fits \
                              ${obsnum}_deep-*-image-pb.fits \
                              ${obsnum}_deep-*-image-pb_warp_weight.fits \
                              ${obsnum}_deep-*-image-pb_warp_rms.fits \
                              ${obsnum}_deep-*-image-pb_warp_bkg.fits \
                              ${obsnum}_deep-*-image-pb_warp_comp.fits \
                              ${obsnum}_*_xm.fits \
                              $user@$host:"$remote/$obsnum"

test_fail $?

echo 'Updating database'
track_task.py obs_status --obs_id=${obsnum} --status=archived

echo "Database updated. Obsid $obsid has been archived. "